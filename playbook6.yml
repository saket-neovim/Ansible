- name: Create multiple users and install nginx
  hosts: all
  become: true
  gather_facts: true
  vars:
    users:
      - name: saket
      - name: devuser
      - name: admin
    nginx_pkg_map:
      Debian: nginx
      RedHat: nginx
  tasks:
    - name: Ensure user accounts exist
      ansible.builtin.user:
        name: "{{ item.name }}"
        shell: /bin/bash
        create_home: true
      loop: "{{ users }}"

    - name: Install nginx
      ansible.builtin.package:
        name: "{{ nginx_pkg_map.get(ansible_facts['os_family'], 'nginx') }}"
        state: present
        update_cache: true

- name: Copy config file and ensure demo file exists
  hosts: all
  become: true
  vars:
    local_copy_src: "/Users/saketb/Documents/Dev/DevOps/Testing.txt"
    remote_work_dir: "/work"
  tasks:
    - name: Ensure remote work directory exists
      ansible.builtin.file:
        path: "{{ remote_work_dir }}"
        state: directory
        mode: "0755"

    - name: Copying file (host2 only)
      ansible.builtin.copy:
        src: "{{ local_copy_src }}"
        dest: "{{ remote_work_dir }}/Testing.txt"
        mode: "0644"
      when: inventory_hostname == 'host2'

    - name: Get stats of demo file
      ansible.builtin.stat:
        path: "{{ remote_work_dir }}/demo.txt"
      register: details

    - name: Create demo file if not present
      ansible.builtin.copy:
        dest: "{{ remote_work_dir }}/demo.txt"
        content: "Demo file created by Ansible\n"
        mode: "0644"
      when: not details.stat.exists

- name: Play 3
  hosts: all
  gather_facts: false
  tasks:
    - name: Ping (host2 only)
      ansible.builtin.ping:
      register: pingdetails
      when: inventory_hostname == 'host2'

    - name: Print result (host2 only)
      ansible.builtin.debug:
        var: pingdetails
      when: inventory_hostname == 'host2'
